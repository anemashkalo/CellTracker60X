
% info on where the images are and whidh position / timepoint to run

ilastikdircyto = ('/Users/warmflashlab/Desktop/A_NEMASHKALO_Data_and_stuff/9_LiveCllImaging/3Dsegmentation_tracking_TrainingSet/masks_zcyto');
ilastikdirnuc = ('/Users/warmflashlab/Desktop/A_NEMASHKALO_Data_and_stuff/9_LiveCllImaging/3Dsegmentation_tracking_TrainingSet/Masks_z2');
imagedir = ('/Users/warmflashlab/Desktop/A_NEMASHKALO_Data_and_stuff/9_LiveCllImaging/3Dsegmentation_tracking_TrainingSet/rawimages_');%rawimages_
pos = 23;
tpt =1;
timegroup = 1;
chan = [1 2];

paramfile = 'setUserParamLiveImagingAN';
paramfile2 = 'setUserParam3DsegmentationAN';
%%
% run all timepoints and save into one peaks
% main fnction:

[~, ilastikCytoAll]=folderFilesFromKeyword(ilastikdircyto,['framecyto' num2str(pos) '_']);   % get the specific position ilastik masks (all z projections)
[~, ilastikNucAll]=folderFilesFromKeyword(ilastikdirnuc,['frame' num2str(pos) '_']);%

imgfilescyto
imgfilescyto
timegroups = 1;
% need this chunck if working with multiple positions and timegroups
% ilastikCytoAll = ilastikCytoAll((pos*timegroups+1):(pos+1)*timegroups); % 1-4; 5-8;...
% ilastikNucAll = ilastikNucAll((pos*timegroups+1):(pos+1)*timegroups);


nTprev = 0;
for j = 1:length(ilastikNucAll)      % loop over the same position time groups
        
   nT = GetNumberTimePointsAN(imagedir,pos,timegroup);    % how many time point are within given time group
    
    for k = 1:nT                                                                       % loop over time points within a given time group
    [pnuc, inuc]   =  readmaskfiles1(ilastikNucAll,imagedir, pos,k, j,chan(1));        % get the raw images for that position and merge them into a 3d format
    [pcyto, icyto] =  readmaskfiles1(ilastikCytoAll,imagedir, pos,k, j,chan(2));     
               
    [outdat,Lnuc,Lcytofin] = runmaskoneANdata(pnuc,pcyto,inuc,icyto,pos,k,timegroup,paramfile);
    
       % [outdat, Lnuc,Lcytofin] = nucCytoIlastik2peaks(nuc_mask_all(:,:,k),cyto_mask_all(:,:,k),nuc_img,nuc_cyto,paramfile);%
        peaks{nTprev+k} = outdat;
        
        imgfiles(nTprev+k).NucMask = Lnuc; %compressBinaryImg
        imgfilescyto(nTprev+k).NucMask = Lcytofin;
                
    end
    nTprev = nTprev + nT;
end

% save(outfile,'peaks','imgfiles');
save([ num2str(pos) '_' num2str(outfile)],'peaks','imgfiles','imgfilescyto');

end
